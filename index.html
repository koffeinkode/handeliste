<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle Litt</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap');

        :root {
            --primary: #d97706;
            --primary-hover: #c2410c;
            --primary-light: rgba(217, 119, 6, 0.1);

            --secondary: #84cc16;
            --success: #65a30d;
            --danger: #dc2626;

            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Bricolage Grotesque', -apple-system, sans-serif;
            background:
                radial-gradient(ellipse at 20% 30%, rgba(217, 119, 6, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 70%, rgba(132, 204, 22, 0.10) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 90%, rgba(251, 191, 36, 0.08) 0%, transparent 60%),
                linear-gradient(135deg, #fefcf5 0%, #f5f3e8 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #1d1d1f;
            margin-bottom: 32px;
            position: relative;
        }

        .language-toggle {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            padding: 4px;
        }

        .language-toggle button {
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.15s ease;
            opacity: 0.5;
            min-width: auto;
            line-height: 1;
        }

        .language-toggle button.active {
            background: white;
            opacity: 1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .language-toggle button:hover:not(.active) {
            opacity: 0.8;
        }

        h1 {
            font-family: 'Bricolage Grotesque', sans-serif;
            font-size: 6em;
            margin-top: 48px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -2.5px;
            color: var(--primary);
        }

        .adhd-explanation {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.08), rgba(132, 204, 22, 0.08));
            border: 1px solid rgba(217, 119, 6, 0.2);
            border-radius: 10px;
            padding: 16px 20px;
            margin: 0 auto 24px auto;
            max-width: 1100px;
            text-align: center;
            font-size: 14px;
            line-height: 1.6;
        }

        .adhd-explanation strong {
            color: #c2410c;
            font-weight: 600;
        }

        .controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow:
                0 8px 32px rgba(31, 38, 135, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            position: relative;
            z-index: 100;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        #searchInput {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
            font-family: inherit;
            resize: none;
            overflow: hidden;
            height: 48px;
            max-height: 200px;
            line-height: 1.5;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        #autocomplete {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .autocomplete-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--primary-light);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-category {
            font-size: 0.85em;
            color: #86868b;
            font-weight: 400;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 7px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            flex: 1;
            min-width: 150px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-primary:active {
            background: var(--primary-hover);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:active {
            background: rgba(0, 0, 0, 0.12);
            transform: scale(0.98);
        }

        .shopping-list {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 24px;
            box-shadow:
                0 8px 32px rgba(31, 38, 135, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .category {
            margin-bottom: 24px;
        }

        .category:last-child {
            margin-bottom: 0;
        }

        .category-header {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25em;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1d1d1f;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-count {
            font-size: 0.75em;
            color: #86868b;
            font-weight: 400;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 7px;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .item.checked {
            opacity: 0.4;
        }

        .item.checked .item-name {
            text-decoration: line-through;
        }

        .item.highlight {
            background: rgba(52, 199, 89, 0.15);
            border-color: rgba(52, 199, 89, 0.3);
            animation: fadeHighlight 3s ease-out forwards;
        }

        @keyframes fadeHighlight {
            0% {
                background: rgba(52, 199, 89, 0.25);
                border-color: rgba(52, 199, 89, 0.4);
            }
            100% {
                background: rgba(0, 0, 0, 0.02);
                border-color: rgba(0, 0, 0, 0.04);
            }
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .item-name {
            flex: 1;
            font-size: 15px;
            color: #1d1d1f;
        }

        .item-note {
            font-size: 13px;
            color: #86868b;
            font-style: italic;
            margin-top: 3px;
        }

        .edit-note-btn {
            background: transparent;
            color: #86868b;
            border: none;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.15s ease;
            min-width: auto;
            line-height: 1;
            opacity: 0.6;
        }

        .edit-note-btn:hover {
            background: rgba(217, 119, 6, 0.1);
            color: var(--primary);
            opacity: 1;
        }

        .edit-note-btn:active {
            transform: scale(0.95);
        }

        .delete-btn {
            background: transparent;
            color: #86868b;
            border: none;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 400;
            transition: all 0.15s ease;
            min-width: auto;
            line-height: 1;
            opacity: 0.6;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
            opacity: 1;
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 28px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.16);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1d1d1f;
            letter-spacing: -0.3px;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            color: #86868b;
            min-width: auto;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #1d1d1f;
        }

        #bulkTextarea {
            width: 100%;
            min-height: 200px;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', monospace;
            resize: vertical;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
        }

        #bulkTextarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .preview-section {
            margin-bottom: 20px;
        }

        .preview-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1d1d1f;
            font-size: 0.95em;
        }

        .preview-items {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-item {
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        .preview-item-text {
            font-weight: 500;
            color: #1d1d1f;
        }

        .preview-item-category {
            font-size: 0.85em;
            color: #86868b;
            margin-left: 10px;
        }

        .unrecognized-items {
            margin-top: 15px;
        }

        .unrecognized-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .unrecognized-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.6);
        }

        .unrecognized-item select {
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 900px) {
            .shopping-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
            }

            header {
                display: grid;
                grid-template-areas:
                    "lang"
                    "title"
                    "subtitle";
                gap: 12px;
            }

            .language-toggle {
                position: static;
                grid-area: lang;
                justify-self: center;
            }

            h1 {
                font-size: 4.5em;
                grid-area: title;
            }

            .subtitle {
                grid-area: subtitle;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                min-width: 100%;
            }

            .modal-content {
                padding: 24px;
            }

            .modal-header {
                font-size: 1.3em;
            }

            .controls, .shopping-list {
                padding: 20px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-toggle">
                <button onclick="setLanguage('no')" class="active" id="lang-no">üá≥üá¥</button>
                <button onclick="setLanguage('en')" id="lang-en">üá¨üáß</button>
            </div>
            <h1 id="app-title">Handle Litt</h1>
        </header>

        <div class="adhd-explanation">
            <p id="adhd-text"></p>
        </div>

        <div class="controls">
            <div class="search-container">
                <textarea id="searchInput" rows="1" placeholder="Lim inn handleliste eller s√∏k etter vare..."></textarea>
                <div id="autocomplete"></div>
            </div>
            <div id="previewSection" style="display: none; margin-top: 16px;">
                <div class="preview-header">Gjenkjente varer (<span id="inlineRecognizedCount">0</span>):</div>
                <div class="preview-items" id="inlineRecognizedItems" style="margin-bottom: 12px;"></div>

                <div id="inlineUnrecognizedContainer" style="display: none;">
                    <div class="preview-header">Ukjente varer - velg kategori:</div>
                    <div id="inlineUnrecognizedItems" style="margin-bottom: 12px;"></div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" id="addAllBtn" onclick="addParsedItems()" style="flex: 1;">‚úÖ Legg til alle</button>
                    <button class="btn-secondary" id="cancelBtn" onclick="cancelBulkInput()" style="flex: 1;">Avbryt</button>
                </div>
            </div>
            <div class="button-group" style="margin-top: 12px;">
                <button class="btn-secondary" onclick="shareList()">üì§ Del liste</button>
                <button class="btn-secondary" onclick="showImportModal()">üì• Importer liste</button>
                <button class="btn-secondary" onclick="clearList()">üóëÔ∏è T√∏m liste</button>
            </div>
        </div>

        <div class="shopping-list" id="shoppingList">
        </div>

        <footer style="text-align: center; margin-top: 40px; padding: 20px; color: #86868b; font-size: 14px;">
            <p id="footer-credit" style="margin: 0 0 8px 0;">Et lite prosjekt av Hallvar Bugge Johnsen - <a href="mailto:hei@hallvar.no" style="color: var(--primary); text-decoration: none;">hei@hallvar.no</a></p>
            <p id="privacy-notice" style="margin: 0; font-size: 13px; opacity: 0.8;">üîí All data lagres kun lokalt i nettleserens cache. Ingenting forlater enheten din.</p>
        </footer>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeShareModal()">√ó</button>
            <h2 class="modal-header" id="shareModalTitle">Del handleliste</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <div id="qrcode" style="display: inline-block; padding: 20px; background: white; border-radius: 8px;"></div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;" id="shareCodeLabel">Eller del denne koden:</label>
                <input type="text" id="shareCode" readonly style="width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; font-size: 13px; background: rgba(0,0,0,0.02);">
                <button class="btn-primary" onclick="copyShareCode()" style="margin-top: 10px; width: 100%;">üìã Kopier kode</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImportModal()">√ó</button>
            <h2 class="modal-header" id="importModalTitle">Importer handleliste</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;" id="importCodeLabel">Lim inn kode:</label>
                <input type="text" id="importCode" placeholder="Lim inn kode her..." style="width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; font-size: 13px;">
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="importList()">‚úÖ Importer</button>
                <button class="btn-secondary" onclick="closeImportModal()">Avbryt</button>
            </div>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeNoteModal()">√ó</button>
            <h2 class="modal-header" id="noteModalTitle">Rediger notat</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;" id="noteItemName"></label>
                <input type="text" id="noteInput" placeholder="F.eks: 4 stk, 2 kg, √∏kologisk..." style="width: 100%; padding: 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 15px;">
            </div>
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveNote()">‚úÖ Lagre</button>
                <button class="btn-secondary" onclick="closeNoteModal()">Avbryt</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUqnhuWdzRJBloEwZk05zWGwd5LOcrTf0",
            authDomain: "handlelitt.firebaseapp.com",
            projectId: "handlelitt",
            storageBucket: "handlelitt.firebasestorage.app",
            messagingSenderId: "592202081634",
            appId: "1:592202081634:web:7fa02585685b9a2719b83b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const functions = firebase.functions();

        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
            .catch(err => {
                if (err.code === 'failed-precondition') {
                    console.warn('Persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.warn('Persistence not supported by browser');
                }
            });

        let currentLanguage = localStorage.getItem('language') || 'no';

        const TRANSLATIONS = {
            no: {
                appTitle: 'Handle Litt',
                appSubtitle: 'Lim inn handleliste eller s√∏k etter enkelvarer',
                searchPlaceholder: 'Lim inn handleliste eller s√∏k etter vare...',
                clearListBtn: 'üóëÔ∏è T√∏m liste',
                shareListBtn: 'üì§ Del liste',
                importListBtn: 'üì• Importer liste',
                addAllBtn: '‚úÖ Legg til alle',
                cancelBtn: 'Avbryt',
                shareModalTitle: 'Del handleliste',
                shareCodeLabel: 'Eller del denne koden:',
                copyCodeBtn: 'üìã Kopier kode',
                importModalTitle: 'Importer handleliste',
                importCodeLabel: 'Lim inn kode:',
                importCodePlaceholder: 'Lim inn kode her...',
                importBtn: '‚úÖ Importer',
                codeCopied: 'Kode kopiert!',
                importSuccess: 'Handleliste importert!',
                importError: 'Ugyldig kode. Vennligst pr√∏v igjen.',
                recognizedItems: 'Gjenkjente varer',
                unknownItems: 'Ukjente varer - velg kategori',
                selectCategory: 'Velg kategori',
                noItemsYet: 'Ingen varer lagt til enn√•.',
                noItemsDesc: 'Lim inn en liste eller s√∏k etter enkelvarer i feltet over',
                alertSelectCategory: 'Vennligst velg kategori for alle ukjente varer!',
                alertConfirmClear: 'Er du sikker p√• at du vil t√∏mme hele listen?',
                alertListEmpty: 'Listen er allerede tom!',
                adhdExplanation: 'Surrer du p√• kryss og tvers i butikken? Her kan du lime inn en usortert handleliste, og Handle Litt vil sortere den etter kategorierüî•',
                categories: {
                    'Frukt & Gr√∏nt': 'ü•¨ Frukt & Gr√∏nt',
                    'Kj√∏tt & Fisk': 'ü•© Kj√∏tt & Fisk',
                    'Meieri & Kj√∏l': 'ü•õ Meieri & Kj√∏l',
                    'Br√∏d & Bakervarer': 'üçû Br√∏d & Bakervarer',
                    'T√∏rrvarelager & Hermetikk': 'ü•´ T√∏rrvarelager & Hermetikk',
                    'Fryste varer': 'üßä Fryste varer',
                    'Urter & Krydder': 'üåø Urter & Krydder',
                    'Drikke': 'ü•§ Drikke',
                    'Godteri & Snacks': 'üç¨ Godteri & Snacks',
                    'Husholdning & Rengj√∏ring': 'üßπ Husholdning & Rengj√∏ring',
                    'Vinmonopolet': 'üç∑ Vinmonopolet',
                    'Kontorartikler': 'üìé Kontorartikler',
                    'M√∏belbutikk': 'üõãÔ∏è M√∏belbutikk',
                    'Skredder': 'üßµ Skredder',
                    'Bensinstasjon': '‚õΩ Bensinstasjon',
                    'Kaffebar/Kafeer': '‚òï Kaffebar/Kafeer',
                    'Post': 'üìÆ Post',
                    'Diverse': 'üì¶ Diverse'
                },
                footerCredit: 'Et lite prosjekt av Hallvar Bugge Johnsen',
                privacyNotice: 'üîí All data lagres kun lokalt i nettleserens cache. Ingenting forlater enheten din.'
            },
            en: {
                appTitle: 'Handle Litt',
                appSubtitle: 'Paste your list or search for items',
                searchPlaceholder: 'Paste shopping list or search for items...',
                clearListBtn: 'üóëÔ∏è Clear list',
                shareListBtn: 'üì§ Share list',
                importListBtn: 'üì• Import list',
                addAllBtn: '‚úÖ Add all',
                cancelBtn: 'Cancel',
                shareModalTitle: 'Share shopping list',
                shareCodeLabel: 'Or share this code:',
                copyCodeBtn: 'üìã Copy code',
                importModalTitle: 'Import shopping list',
                importCodeLabel: 'Paste code:',
                importCodePlaceholder: 'Paste code here...',
                importBtn: '‚úÖ Import',
                codeCopied: 'Code copied!',
                importSuccess: 'Shopping list imported!',
                importError: 'Invalid code. Please try again.',
                recognizedItems: 'Recognized items',
                unknownItems: 'Unknown items - select category',
                selectCategory: 'Select category',
                noItemsYet: 'No items added yet.',
                noItemsDesc: 'Paste a list or search for items in the field above',
                alertSelectCategory: 'Please select category for all unknown items!',
                alertConfirmClear: 'Are you sure you want to clear the entire list?',
                alertListEmpty: 'The list is already empty!',
                adhdExplanation: 'Shopping in circles? Here you can paste an unsorted shopping list, and Handle Litt will sort it by categoriesüî•',
                categories: {
                    'Frukt & Gr√∏nt': 'ü•¨ Fruits & Vegetables',
                    'Kj√∏tt & Fisk': 'ü•© Meat & Fish',
                    'Meieri & Kj√∏l': 'ü•õ Dairy & Refrigerated',
                    'Br√∏d & Bakervarer': 'üçû Bread & Bakery',
                    'T√∏rrvarelager & Hermetikk': 'ü•´ Pantry & Canned Goods',
                    'Fryste varer': 'üßä Frozen Foods',
                    'Urter & Krydder': 'üåø Herbs & Spices',
                    'Drikke': 'ü•§ Beverages',
                    'Godteri & Snacks': 'üç¨ Candy & Snacks',
                    'Husholdning & Rengj√∏ring': 'üßπ Household & Cleaning',
                    'Vinmonopolet': 'üç∑ Liquor Store',
                    'Kontorartikler': 'üìé Office Supplies',
                    'M√∏belbutikk': 'üõãÔ∏è Furniture Store',
                    'Skredder': 'üßµ Tailor',
                    'Bensinstasjon': '‚õΩ Gas Station',
                    'Kaffebar/Kafeer': '‚òï Coffee Shop',
                    'Post': 'üìÆ Post Office',
                    'Diverse': 'üì¶ Miscellaneous'
                },
                footerCredit: 'A small project by Hallvar Bugge Johnsen',
                privacyNotice: 'üîí All data is stored locally in your browser cache only. Nothing leaves your device.'
            }
        };

        const CATEGORIES = [
            'Frukt & Gr√∏nt',
            'Kj√∏tt & Fisk',
            'Meieri & Kj√∏l',
            'Br√∏d & Bakervarer',
            'T√∏rrvarelager & Hermetikk',
            'Fryste varer',
            'Urter & Krydder',
            'Drikke',
            'Godteri & Snacks',
            'Husholdning & Rengj√∏ring',
            'Vinmonopolet',
            'Kontorartikler',
            'M√∏belbutikk',
            'Skredder',
            'Bensinstasjon',
            'Kaffebar/Kafeer',
            'Post',
            'Diverse'
        ];

        const DATABASE = {
            'Frukt & Gr√∏nt': [
                'eple', 'banan', 'appelsin', 'p√¶re', 'drue', 'kiwi', 'mango', 'ananas', 'melon', 'vannmelon',
                'sitron', 'lime', 'grapefrukt', 'klementiner', 'mandarin', 'persimmon', 'avokado', 'papaya',
                'gulrot', 'tomat', 'agurk', 'paprika', 'salat', 'isbergsalat', 'ruccola', 'spinat', 'gr√∏nnk√•l',
                'brokkoli', 'blomk√•l', 'l√∏k', 'r√∏dl√∏k', 'hvitl√∏k', 'ingef√¶r', 'chili', 'squash', 'zucchini',
                'purre', 'selleri', 'k√•lrot', 'nepe', 'r√∏dbete', 'hodek√•l', 'rosenk√•l', 's√∏tpotet', 'potet',
                'asparges', 'mais', 'erter', 's√∏tpotet', 'sopp', 'sjampinjong', '√∏sterssopp', 'kantarell'
            ],
            'Kj√∏tt & Fisk': [
                'kyllingfilet', 'kyllingl√•r', 'kyllingvinger', 'hel kylling', 'kalkunfilet', 'kalkun',
                'kj√∏ttdeig', 'storfekj√∏tt', 'indrefilet', 'm√∏rbrad', 'ytrefilet', 'entrec√¥te', 'storfefilet',
                'koteletter', 'svinekoteletter', 'lammekoteletter', 'pulled pork', 'bacon', 'skinke', 'flesk',
                'lammekj√∏tt', 'lammestek', 'reinsdyrskj√∏tt', 'elgkj√∏tt', 'p√∏lser', 'grillp√∏lser',
                'laks', '√∏rret', 'torsk', 'sei', 'hyse', 'kveite', 'makrell', 'sild', 'tunfisk', 'reker',
                'krabbe', 'kongekrabbe', 'hummer', 'bl√•skjell', 'kamskjell', 'fiskeboller', 'fiskekaker', 'surimi'
            ],
            'Meieri & Kj√∏l': [
                'melk', 'lettmelk', 'skummet melk', 'helmelk', 'ekstra lett melk', 'kulturmelk', 'kefir',
                'fl√∏te', 'matfl√∏te', 'kremfl√∏te', 'piskefl√∏te', 'cr√®me fraiche', 'r√∏mme', 'lett r√∏mme', 'kesam',
                'yoghurt', 'gresk yoghurt', 'naturell yoghurt', 'fruktyhgurt',
                'ost', 'hvitost', 'gulost', 'norvegia', 'jarlsberg', 'cheddar', 'mozzarella', 'parmesan',
                'brie', 'camembert', 'feta', 'cottage cheese', 'kremost', 'sm√∏reost', 'bl√•muggost', 'geitost',
                'sm√∏r', 'margarin', 'bremykt', 'meierism√∏r', 'lettmargarin',
                'egg', 'eggehvite', 'majones', 'aioli', 'remulade', 'chilimajones'
            ],
            'Br√∏d & Bakervarer': [
                'br√∏d', 'loff', 'rundstykker', 'baguett', 'ciabatta', 'focaccia', 'grovbr√∏d', 'kneippbr√∏d',
                'byggbr√∏d', 'havregr√∏t', 'havrebr√∏d', 'glutenfritt br√∏d', 'pitabr√∏d', 'tortilla', 'wraps',
                'bagel', 'croissant', 'bolle', 'kanelboller', 'wienbr√∏d', 'skolebr√∏d', 'kaker', 'wienerbr√∏d',
                'knekkebr√∏d', 'kavring', 'kornkjeks', 'kjeks', 'riskjeks', 'havregr√∏tmel', 'm√ºsli', 'frokostblanding',
                'cornflakes', 'havregryn', 'havregrynspudding', 'mandelskiver', 'mandelflak', 'sjokoladebiter', 'sjokoladedr√•per'
            ],
            'T√∏rrvarelager & Hermetikk': [
                'pasta', 'spaghetti', 'makaroni', 'penne', 'fusilli', 'lasagneplater', 'tortellini', 'ravioli',
                'ris', 'jasminris', 'basmatiris', 'risotto', 'parboiled ris', 'sushiris',
                'mel', 'hvetemel', 'sammalt hvete', 'glutenfritt mel', 'mandelmel', 'siktet sammalt hvete',
                'sukker', 'melis', 'flormelis', 'brunt sukker', 'r√∏rsukker', 'honning', 'sirup', 'agavesirup',
                'havsalt', 'bordsalt', 'pepper', 'paprika', 'karri', 'kanel', 'muskatn√∏tt', 'nellik',
                'bakepulver', 'natron', 'vaniljesukker', 'vaniljestang', 'gj√¶r', 't√∏rrgj√¶r', 'kakao',
                'hermetiske tomater', 'tomatpure', 'tomatketchup', 'hermetisk mais', 'hermetiske erter',
                'hermetiske kikerter', 'hermetiske b√∏nner', 'hermetisk tunfisk', 'hermetisk makrell', 'hermetisk ananas',
                'kokosmelk', 'hermetisk kokosmelk',
                'pesto', 'tapenade', 'olivenolje', 'rapsolje', 'kokosolje', 'sm√∏rolje', 'solsikkeolje',
                'eddik', 'balsamicoeddik', 'r√∏dvinseddik', 'eplesidereddik', 'soyasaus', 'fiskesaus', 'osterssaus',
                'buljong', 'kraft', 'h√∏nsekraft', 'gr√∏nnsakskraft', 'biff', 'pean√∏ttsm√∏r', 'hazelnut spread', 'nutella',
                'syltet√∏y', 'jordb√¶rsyltet√∏y', 'bringeb√¶rsyltet√∏y', 'aprikos syltet√∏y', 'appelsinmarmelade',
                'm√ºslibarer', 'proteinbarer', 'n√∏tter', 'mandler', 'cashewn√∏tter', 'pean√∏tter', 'hasseln√∏tter',
                'rosiner', 't√∏rkede aprikoser', 't√∏rkede kranb√¶r', 't√∏rket frukt'
            ],
            'Fryste varer': [
                'frosne erter', 'frosne gr√∏nnsaker', 'frosne gr√∏nnsaksblandinger', 'frosne b√¶r', 'frosne jordb√¶r',
                'frosne bl√•b√¶r', 'frosne bringeb√¶r', 'frosne tytteb√¶r', 'frosne mango', 'frosne b√¶rblandinger',
                'pizza', 'grandiosa', 'ferdigmat', 'lasagne', 'fiskegrateng', 'pytt i panne', 'tacokj√∏tt',
                'is', 'iskrem', 'sorb√©t', 'pinneis', 'ispinne', 'isvafler',
                'pommes frites', 'potetb√•ter', 'potetskiver', 'kroketter', 'fiskefileter', 'fiskepinner',
                'panert fisk', 'frossenpudding'
            ],
            'Urter & Krydder': [
                'salt', 'pepper', 'basilikum', 'oregano', 'timian', 'rosmarin', 'persille', 'koriander',
                'dill', 'gressl√∏k', 'mynta', 'salvie', 'estragon', 'laurb√¶rblad', 'karri', 'karripasta',
                'kurkuma', 'spisskummen', 'koriafr√∏', 'chiliflak', 'chipotle', 'cayennepepper',
                'paprikapulver', 's√∏t paprika', 'r√∏kt paprika', 'hvitl√∏kspulver', 'l√∏kpulver',
                'muskatn√∏tt', 'kardemomme', 'nellik', 'stjerneanis', 'kanel', 'vaniljesukker', 'ingef√¶r',
                'sesamfr√∏', 'valmuefr√∏', 'solsikkefr√∏', 'gresskarkjerner', 'chiafr√∏', 'linfr√∏'
            ],
            'Drikke': [
                'vann', 'kildevann', 'kullsyreholdig vann', 'mineralvann', 'brus', 'cola', 'solo', 'fanta',
                'sprite', 'pepsi', 'saft', 'eplejuice', 'appelsinjuice', 'juice', 'smoothie',
                'kaffe', 'kaffeb√∏nner', 'filterkaffe', 'espresso', 'te', 'gr√∏nn te', 'svart te', 'urte te',
                'kakao', 'sjokolademelk', 'energidrikk', 'sportsdrikk', 'proteinshake', 'kokosvann',
                '√∏l', 'pilsner', 'lager', 'alkoholfri √∏l', 'alkoholfri vin', 'lett√∏l'
            ],
            'Godteri & Snacks': [
                'sjokolade', 'melkesjokolade', 'm√∏rk sjokolade', 'kvikk lunsj', 'stratos', 'freia melkesjokolade',
                'twist', 'smash', 'non stop', 'center', 'marianne', 'drops', 'mintedropser',
                'godteri', 'vingummi', 'gel√©', 'lakris', 'salt lakris', 's√∏t lakris', 'lollipop', 'pastiller',
                'tyggis', 'popcorn', 'mikropopcorn', 'chips', 'potetchips', 's√∏rlandschips', 'maarud',
                'nachos', 'tortillachips', 'salsa', 'guacamole', 'dipp', 'pean√∏tter', 'salte pean√∏tter',
                'cashewn√∏tter', 'n√∏tteblanding', 'studenthaver', 'trail mix', 'kjeks', 'sm√•kjeks',
                's√∏rlandskjeks', 'digestive', 'ballerina', 'havrekjeks'
            ],
            'Husholdning & Rengj√∏ring': [
                'oppvaskmiddel', 'oppvaskmaskinmiddel', 'oppvaskmaskin tabletter', 'oppvaskb√∏rste', 'oppvaskklut',
                't√∏rk', 'rengj√∏ring', 'allrens', 's√•pe', 's√•pepumpe', 'toalettpapir', 'dopapir', 'kj√∏kkenruller',
                'papirh√•ndkle', 'servietter', 'v√•tservietter', 'kluter', 'filler', 'svamp', 'skuresvamp',
                'skurepulver', 'klorin', 'klorkluter', 'desinfeksjon', 'gulvvask', 'vindusrens', 'glassrens',
                'badrens', 'kalkfjerner', 'universal rengj√∏ringsmiddel', 'ovnsrens', 'komfyrrens',
                't√∏yvask', 'vaskemiddel', 'flytende vaskemiddel', 't√∏ymykner', 'fargeark', 'vaskepulver',
                's√•peflak', 'flekktjerner', 'blekmiddel', 'uldvask',
                's√∏ppelposer', 'matposer', 'fryseposer', 'br√∏dposer', 'aluminiumsfolie', 'plastfolie', 'bakepapir'
            ],
            'Vinmonopolet': [
                'sterk√∏l', 'ipa', 'pale ale', 'stout', 'porter', 'brown ale', 'wheat beer', 'witbier',
                'vin', 'r√∏dvin', 'hvitvin', 'ros√©vin', 'musserende vin', 'champagne', 'prosecco', 'cava',
                'cider', 'eplesider', 'p√¶recider',
                'brennevin', 'vodka', 'whisky', 'gin', 'rom', 'tequila', 'cognac', 'lik√∏r', 'baileys', 'kahlua',
                'aperol', 'campari', 'vermut', 'sherry', 'portvin', 'madeira'
            ],
            'Kontorartikler': [
                'kulepenn', 'blyant', 'viskel√¶r', 'notisblokk', 'post-it', 'lapper', 'ringperm', 'plastlommer',
                'clips', 'binders', 'stifter', 'stiftepistol', 'hullmaskin', 'teip', 'tape', 'dobbeltsidig tape',
                'kalkulator', 'saks', 'kontorsaks', 'linjal', 'lim', 'limstift', 'tusj', 'marker', 'highlighter',
                'A4 papir', 'skrivepapir', 'konvolutt', 'hvite konvolutter', 'brune konvolutter', 'etiketter',
                'merkelapper', 'batterier', 'AA batterier', 'AAA batterier', 'USB kabel', 'USB minne', 'ladekabel'
            ],
            'M√∏belbutikk': [
                'lysp√¶re', 'LED p√¶re', 'sparep√¶re', 'halogen p√¶re', 'E27 p√¶re', 'E14 p√¶re', 'GU10 p√¶re',
                'stueplanter', 'potteplanter', 'blomsterpotte', 'blomsterkrukke', 'plantepotte', 'kaktus',
                'pute', 'sofapute', 'prydspute', 'putev√•r', 'pledd', 'ullteppe', 'fleeceteppe',
                'gardin', 'persienne', 'rullegardin', 'gardinkrok', 'gardinhengsler', 'gardinstang',
                'bilderamme', 'fotoramme', 'veggdekor', 'speil', 'veggspeil',
                'stearinlys', 'tente lys', 'duftlys', 'fyrfadslys', 'kubbelys', 'kronelys', 'lighter', 'fyrstikker',
                'kurv', 'oppbevaringskurv', 'flettekurv', 'vase', 'glassvase', 'keramikvase',
                'matte', 'teppe', 'd√∏rmatte', 'badematte', 'teppeunderlag'
            ],
            'Skredder': [
                'tr√•d', 'symaskintr√•d', 'bomullstr√•d', 'polyestertr√•d', 'n√•l', 'syn√•l', 'h√•ndsyn√•l', 'maskinn√•l',
                'knapp', 'knapper', 'trykknapp', 'glidel√•s', 'lynl√•s', 'saks', 'stoffsaks', 'tr√•dsaks',
                'm√•leb√•nd', 'symeterb√•nd', 'stoppetr√•d', 'ulltr√•d', 'garn', 'strikket√∏y', 'strikkegarn',
                'strikkepinner', 'rundpinner', 'heklen√•l', 'knappen√•l', 'sikkerhetsn√•l', 's√∏mriper',
                'stoff', 'bomullsstoff', 'jersey', 'fleece', 'filterstoff'
            ],
            'Bensinstasjon': [
                'bensin', '95 oktan', '98 oktan', 'diesel', 'biodiesel', 'spylev√¶ske', 'vindusspylev√¶ske',
                'motorolje', 'bilstell', 'bilshampoo', 'issskrape', 'isskrape', 'ispray', 'aviser',
                'luftfrisker bil', 'bilparfyme', 'bilduft', 'vaskeklut', 'bilklut', 'mikrofiberklut',
                'kaffe', 'varm p√∏lse', 'p√∏lse', 'varmmat', 'nachos', 'energidrikk', 'redbull', 'battery',
                'lightere', 'isbit', 'energibar', 'kj√∏lev√¶ske', 'bremsev√¶ske', 'startkabler'
            ],
            'Kaffebar/Kafeer': [
                'espresso', 'dobbel espresso', 'americano', 'latte', 'cappuccino', 'flat white', 'cortado',
                'macchiato', 'mocha', 'iskaffe', 'iced latte', 'cold brew', 'frapp√©', 'kaffe', 'filterkaffe',
                'te', 'chai latte', 'matcha latte', 'varm sjokolade', 'kakao', 'iste',
                'croissant', 'sm√∏rcroissant', 'sjokoladecroissant', 'mandelcroissant',
                'kanelbolle', 'kanelsnurr', 'skillingsbolle', 'bolle', 'wienerbr√∏d', 'kardemommebolle',
                'muffins', 'bl√•b√¶rmuffins', 'sjokolademuffins', 'brownie', 'cookies', 'sjokoladekjeks',
                'sandwich', 'toast', 'panini', 'wrap', 'salat', 'suppe', 'quiche',
                'smoothie', 'juice', 'friskpresset juice', 'yoghurt', 'havregr√∏t', 'granola',
                'havrmelk', 'soyamelk', 'mandelmelk', 'kokosmelk', 'melkealternativ', 'ekstra shot', 'sirup'
            ],
            'Post': [
                'frimerke', 'frimerker', 'A-post frimerke', 'B-post frimerke', 'porto', 'portosats',
                'konvolutt', 'C5 konvolutt', 'C4 konvolutt', 'boblekonvolutt', 'luftekonvolutt',
                'pakketape', 'brunt tape', 'emballasjeteip', 'pakkepapir', 'bobleplast',
                'eske', 'pappkasse', 'pappeske', 'pakkelapp', 'adresseetikett', 'adresselapp',
                'tollpapir', 'tolldeklarasjon', 'CN23', 'avsenderlapp', 'returlapp',
                'blyant', 'brevvekt', 'plastpose', 'pakkepose', 'postsekk'
            ],
            'Diverse': [
                'gavepapir', 'gavepose', 'gaveb√•nd', 'sl√∏yfe', 'gave etikett', 'kort', 'bursdagskort',
                'gratulasjonskort', 'takkekort', 'invitasjon', 'konvolutt', 'ballonger', 'servietter',
                'festservietter', 'papirbord', 'papptallerkener', 'plastkopper', 'papirkopper', 'suger√∏r',
                'festpynt', 'girlander', 'vimpel', 'konfetti', 'stearinlys', 'telys', 'festlys', 'kakedekorasjon'
            ]
        };

        const DATABASE_EN = {
            'Frukt & Gr√∏nt': [
                'apple', 'banana', 'orange', 'pear', 'grape', 'kiwi', 'mango', 'pineapple', 'melon', 'watermelon',
                'lemon', 'lime', 'grapefruit', 'clementine', 'mandarin', 'persimmon', 'avocado', 'papaya',
                'carrot', 'tomato', 'cucumber', 'bell pepper', 'lettuce', 'iceberg lettuce', 'arugula', 'spinach', 'kale',
                'broccoli', 'cauliflower', 'onion', 'red onion', 'garlic', 'ginger', 'chili', 'squash', 'zucchini',
                'leek', 'celery', 'rutabaga', 'turnip', 'beetroot', 'cabbage', 'brussels sprouts', 'sweet potato', 'potato',
                'asparagus', 'corn', 'peas', 'yam', 'mushroom', 'button mushroom', 'oyster mushroom', 'chanterelle'
            ],
            'Kj√∏tt & Fisk': [
                'chicken breast', 'chicken thighs', 'chicken wings', 'whole chicken', 'turkey breast', 'turkey',
                'ground beef', 'beef', 'tenderloin', 'pork tenderloin', 'sirloin', 'ribeye', 'beef fillet',
                'chops', 'pork chops', 'lamb chops', 'pulled pork', 'bacon', 'ham', 'pork',
                'lamb', 'lamb roast', 'reindeer meat', 'venison', 'sausages', 'grilling sausages',
                'salmon', 'trout', 'cod', 'saithe', 'haddock', 'halibut', 'mackerel', 'herring', 'tuna', 'shrimp',
                'crab', 'king crab', 'lobster', 'mussels', 'scallops', 'fish balls', 'fish cakes', 'surimi'
            ],
            'Meieri & Kj√∏l': [
                'milk', 'low fat milk', 'skim milk', 'whole milk', 'extra light milk', 'cultured milk', 'kefir',
                'cream', 'cooking cream', 'double cream', 'whipping cream', 'cr√®me fraiche', 'sour cream', 'light sour cream', 'cottage cheese',
                'yogurt', 'greek yogurt', 'natural yogurt', 'fruit yogurt',
                'cheese', 'white cheese', 'yellow cheese', 'norvegia', 'jarlsberg', 'cheddar', 'mozzarella', 'parmesan',
                'brie', 'camembert', 'feta', 'cottage cheese', 'cream cheese', 'spread cheese', 'blue cheese', 'goat cheese',
                'butter', 'margarine', 'soft margarine', 'dairy butter', 'light margarine',
                'eggs', 'egg whites', 'mayonnaise', 'aioli', 'remoulade', 'chili mayonnaise'
            ],
            'Br√∏d & Bakervarer': [
                'bread', 'white bread', 'rolls', 'baguette', 'ciabatta', 'focaccia', 'whole grain bread', 'rye bread',
                'barley bread', 'oat porridge', 'oat bread', 'gluten free bread', 'pita bread', 'tortilla', 'wraps',
                'bagel', 'croissant', 'bun', 'cinnamon rolls', 'danish pastry', 'custard bun', 'cakes', 'danish',
                'crispbread', 'rusk', 'grain crackers', 'crackers', 'rice crackers', 'oatmeal', 'muesli', 'breakfast cereal',
                'cornflakes', 'rolled oats', 'oat pudding', 'almond slices', 'almond flakes', 'chocolate chips', 'chocolate drops'
            ],
            'T√∏rrvarelager & Hermetikk': [
                'pasta', 'spaghetti', 'macaroni', 'penne', 'fusilli', 'lasagna sheets', 'tortellini', 'ravioli',
                'rice', 'jasmine rice', 'basmati rice', 'risotto', 'parboiled rice', 'sushi rice',
                'flour', 'wheat flour', 'whole wheat flour', 'gluten free flour', 'almond flour', 'sifted whole wheat',
                'sugar', 'powdered sugar', 'icing sugar', 'brown sugar', 'granulated sugar', 'honey', 'syrup', 'agave syrup',
                'sea salt', 'table salt', 'pepper', 'paprika', 'curry', 'cinnamon', 'nutmeg', 'cloves',
                'baking powder', 'baking soda', 'vanilla sugar', 'vanilla bean', 'yeast', 'dry yeast', 'cocoa',
                'canned tomatoes', 'tomato paste', 'ketchup', 'canned corn', 'canned peas',
                'canned chickpeas', 'canned beans', 'canned tuna', 'canned mackerel', 'canned pineapple',
                'coconut milk', 'canned coconut milk',
                'pesto', 'tapenade', 'olive oil', 'canola oil', 'coconut oil', 'butter oil', 'sunflower oil',
                'vinegar', 'balsamic vinegar', 'red wine vinegar', 'apple cider vinegar', 'soy sauce', 'fish sauce', 'oyster sauce',
                'bouillon', 'stock', 'chicken stock', 'vegetable stock', 'beef', 'peanut butter', 'hazelnut spread', 'nutella',
                'jam', 'strawberry jam', 'raspberry jam', 'apricot jam', 'orange marmalade',
                'granola bars', 'protein bars', 'nuts', 'almonds', 'cashews', 'peanuts', 'hazelnuts',
                'raisins', 'dried apricots', 'dried cranberries', 'dried fruit'
            ],
            'Fryste varer': [
                'frozen peas', 'frozen vegetables', 'frozen vegetable mix', 'frozen berries', 'frozen strawberries',
                'frozen blueberries', 'frozen raspberries', 'frozen lingonberries', 'frozen mango', 'frozen berry mix',
                'pizza', 'grandiosa', 'ready meals', 'lasagna', 'fish gratin', 'hash', 'taco meat',
                'ice cream', 'ice cream', 'sorbet', 'popsicle', 'ice pop', 'ice cream cones',
                'french fries', 'potato wedges', 'potato slices', 'croquettes', 'fish fillets', 'fish fingers',
                'breaded fish', 'frozen pudding'
            ],
            'Urter & Krydder': [
                'salt', 'pepper', 'basil', 'oregano', 'thyme', 'rosemary', 'parsley', 'coriander',
                'dill', 'chives', 'mint', 'sage', 'tarragon', 'bay leaves', 'curry', 'curry paste',
                'turmeric', 'cumin', 'coriander seeds', 'chili flakes', 'chipotle', 'cayenne pepper',
                'paprika powder', 'sweet paprika', 'smoked paprika', 'garlic powder', 'onion powder',
                'nutmeg', 'cardamom', 'cloves', 'star anise', 'cinnamon', 'vanilla sugar', 'ginger',
                'sesame seeds', 'poppy seeds', 'sunflower seeds', 'pumpkin seeds', 'chia seeds', 'flax seeds'
            ],
            'Drikke': [
                'water', 'spring water', 'sparkling water', 'mineral water', 'soda', 'cola', 'solo', 'fanta',
                'sprite', 'pepsi', 'juice concentrate', 'apple juice', 'orange juice', 'juice', 'smoothie',
                'coffee', 'coffee beans', 'filter coffee', 'espresso', 'tea', 'green tea', 'black tea', 'herbal tea',
                'cocoa', 'chocolate milk', 'energy drink', 'sports drink', 'protein shake', 'coconut water',
                'beer', 'pilsner', 'lager', 'non-alcoholic beer', 'non-alcoholic wine', 'light beer'
            ],
            'Godteri & Snacks': [
                'chocolate', 'milk chocolate', 'dark chocolate', 'kvikk lunsj', 'stratos', 'freia milk chocolate',
                'twist', 'smash', 'non stop', 'center', 'marianne', 'drops', 'mint drops',
                'candy', 'gummy bears', 'jelly', 'licorice', 'salty licorice', 'sweet licorice', 'lollipop', 'lozenges',
                'chewing gum', 'popcorn', 'microwave popcorn', 'chips', 'potato chips', 's√∏rlandschips', 'maarud',
                'nachos', 'tortilla chips', 'salsa', 'guacamole', 'dip', 'peanuts', 'salted peanuts',
                'cashews', 'nut mix', 'trail mix', 'trail mix', 'cookies', 'small cookies',
                'butter cookies', 'digestive', 'ballerina', 'oat cookies'
            ],
            'Husholdning & Rengj√∏ring': [
                'dish soap', 'dishwasher detergent', 'dishwasher tablets', 'dish brush', 'dish cloth',
                'paper towels', 'cleaning', 'all-purpose cleaner', 'soap', 'soap dispenser', 'toilet paper', 'toilet paper', 'kitchen rolls',
                'paper towels', 'napkins', 'wet wipes', 'cloths', 'rags', 'sponge', 'scrub sponge',
                'scouring powder', 'bleach', 'chlorine wipes', 'disinfectant', 'floor cleaner', 'window cleaner', 'glass cleaner',
                'bathroom cleaner', 'limescale remover', 'universal cleaner', 'oven cleaner', 'stove cleaner',
                'laundry', 'laundry detergent', 'liquid detergent', 'fabric softener', 'color catcher', 'washing powder',
                'soap flakes', 'stain remover', 'bleach', 'wool wash',
                'garbage bags', 'shopping bags', 'freezer bags', 'bread bags', 'aluminum foil', 'plastic wrap', 'baking paper'
            ],
            'Vinmonopolet': [
                'strong beer', 'ipa', 'pale ale', 'stout', 'porter', 'brown ale', 'wheat beer', 'witbier',
                'wine', 'red wine', 'white wine', 'ros√© wine', 'sparkling wine', 'champagne', 'prosecco', 'cava',
                'cider', 'apple cider', 'pear cider',
                'spirits', 'vodka', 'whisky', 'gin', 'rum', 'tequila', 'cognac', 'liqueur', 'baileys', 'kahlua',
                'aperol', 'campari', 'vermouth', 'sherry', 'port wine', 'madeira'
            ],
            'Kontorartikler': [
                'ballpoint pen', 'pencil', 'eraser', 'notepad', 'post-it', 'sticky notes', 'binder', 'sheet protectors',
                'paper clips', 'binder clips', 'staples', 'stapler', 'hole punch', 'tape', 'tape', 'double sided tape',
                'calculator', 'scissors', 'office scissors', 'ruler', 'glue', 'glue stick', 'marker', 'marker', 'highlighter',
                'A4 paper', 'writing paper', 'envelope', 'white envelopes', 'brown envelopes', 'labels',
                'tags', 'batteries', 'AA batteries', 'AAA batteries', 'USB cable', 'USB drive', 'charging cable'
            ],
            'M√∏belbutikk': [
                'light bulb', 'LED bulb', 'energy saving bulb', 'halogen bulb', 'E27 bulb', 'E14 bulb', 'GU10 bulb',
                'houseplants', 'potted plants', 'flower pot', 'plant pot', 'plant pot', 'cactus',
                'cushion', 'sofa cushion', 'decorative pillow', 'pillow insert', 'throw blanket', 'wool blanket', 'fleece blanket',
                'curtain', 'blinds', 'roller blind', 'curtain hooks', 'curtain rings', 'curtain rod',
                'picture frame', 'photo frame', 'wall decor', 'mirror', 'wall mirror',
                'candle', 'lit candles', 'scented candle', 'tea lights', 'pillar candle', 'taper candle', 'lighter', 'matches',
                'basket', 'storage basket', 'woven basket', 'vase', 'glass vase', 'ceramic vase',
                'mat', 'rug', 'doormat', 'bath mat', 'rug pad'
            ],
            'Skredder': [
                'thread', 'sewing thread', 'cotton thread', 'polyester thread', 'needle', 'sewing needle', 'hand needle', 'machine needle',
                'button', 'buttons', 'snap button', 'zipper', 'zipper', 'scissors', 'fabric scissors', 'thread scissors',
                'measuring tape', 'sewing tape', 'darning thread', 'wool thread', 'yarn', 'knitting supplies', 'knitting yarn',
                'knitting needles', 'circular needles', 'crochet hook', 'safety pin', 'safety pin', 'seam ripper',
                'fabric', 'cotton fabric', 'jersey', 'fleece', 'felt'
            ],
            'Bensinstasjon': [
                'gasoline', '95 octane', '98 octane', 'diesel', 'biodiesel', 'windshield washer fluid', 'windshield washer fluid',
                'motor oil', 'car care', 'car shampoo', 'ice scraper', 'ice scraper', 'de-icer spray', 'newspapers',
                'car air freshener', 'car perfume', 'car scent', 'cleaning cloth', 'car cloth', 'microfiber cloth',
                'coffee', 'hot dog', 'sausage', 'hot food', 'nachos', 'energy drink', 'red bull', 'battery',
                'lighters', 'ice cubes', 'energy bar', 'coolant', 'brake fluid', 'jumper cables'
            ],
            'Kaffebar/Kafeer': [
                'espresso', 'double espresso', 'americano', 'latte', 'cappuccino', 'flat white', 'cortado',
                'macchiato', 'mocha', 'iced coffee', 'iced latte', 'cold brew', 'frapp√©', 'coffee', 'filter coffee',
                'tea', 'chai latte', 'matcha latte', 'hot chocolate', 'cocoa', 'iced tea',
                'croissant', 'butter croissant', 'chocolate croissant', 'almond croissant',
                'cinnamon roll', 'cinnamon bun', 'sweet roll', 'bun', 'danish pastry', 'cardamom bun',
                'muffins', 'blueberry muffins', 'chocolate muffins', 'brownie', 'cookies', 'chocolate cookies',
                'sandwich', 'toast', 'panini', 'wrap', 'salad', 'soup', 'quiche',
                'smoothie', 'juice', 'freshly squeezed juice', 'yogurt', 'oatmeal', 'granola',
                'oat milk', 'soy milk', 'almond milk', 'coconut milk', 'milk alternative', 'extra shot', 'syrup'
            ],
            'Post': [
                'stamp', 'stamps', 'A-mail stamp', 'B-mail stamp', 'postage', 'postage rate',
                'envelope', 'C5 envelope', 'C4 envelope', 'bubble envelope', 'padded envelope',
                'packing tape', 'brown tape', 'packaging tape', 'wrapping paper', 'bubble wrap',
                'box', 'cardboard box', 'cardboard box', 'package label', 'address label', 'address tag',
                'customs form', 'customs declaration', 'CN23', 'sender label', 'return label',
                'pencil', 'postal scale', 'plastic bag', 'mailing bag', 'mail sack'
            ],
            'Diverse': [
                'wrapping paper', 'gift bag', 'ribbon', 'bow', 'gift tag', 'card', 'birthday card',
                'congratulations card', 'thank you card', 'invitation', 'envelope', 'balloons', 'napkins',
                'party napkins', 'paper plates', 'paper plates', 'plastic cups', 'paper cups', 'straws',
                'party decorations', 'garland', 'banner', 'confetti', 'candles', 'tea lights', 'party candles', 'cake decorations'
            ]
        };

        let shoppingList = [];
        let customItems = {};
        let learnedVariants = {};
        let lastAddedItemId = null;
        let lastAddedCategory = null;
        let selectedAutocompleteIndex = -1;
        let currentAutocompleteMatches = [];
        let currentEditingItemId = null;

        const FILLER_WORDS = [
            'kan', 'du', 'handle', 'kj√∏pe', 'hente', 'f√•', 'tak', 'i', 'trenger', 'm√•', 'ha',
            'litt', 'noe', 'noen', 'en', 'et', 'ei', 'og', 'eller', 'ogs√•', 'takk', 'tusen', 'vennligst',
            'gjerne', 'kanskje', 'om', 'mulig', 'hvis', 'dersom', 'n√•r', 'hei', 'hallo', 'hey'
        ];

        const ADJECTIVES = [
            '√∏kologisk', '√∏kologiske', 'fersk', 'ferske', 'frossen', 'frosne', 'fryste', 'fryst',
            'hermetisk', 'hermetiske', 'lett', 'lette', 'ekstra', 'hel', 'hele', 'helle',
            'sk√•ret', 'sk√•rne', 'hakket', 'hakkede', 'r√∏d', 'r√∏de', 'gr√∏nn', 'gr√∏nne',
            'gul', 'gule', 'hvit', 'hvite', 'bl√•', 'norsk', 'norske', 'italiensk', 'italienske',
            'stor', 'store', 'liten', 'sm√•', 'lang', 'lange', 'kort', 'korte', 'fin', 'fine',
            'god', 'gode', 'beste', 'billig', 'billige', 'dyr', 'dyre', 'ny', 'nye', 'gammel', 'gamle'
        ];

        async function initializeApp() {
            // Authenticate user (anonymous or existing)
            await ensureAuthenticated();

            const userId = auth.currentUser.uid;

            // Migrate localStorage to Firestore if needed
            if (!localStorage.getItem('migratedToFirestore')) {
                await migrateLocalStorageToFirestore(userId);
            }

            // Load global items cache
            await loadGlobalItemsCache();

            // Setup real-time listeners
            setupRealtimeListeners(userId);

            // Set initial language button state
            document.getElementById('lang-no').classList.toggle('active', currentLanguage === 'no');
            document.getElementById('lang-en').classList.toggle('active', currentLanguage === 'en');

            updateUI();
            renderList();
            setupSearchListeners();
        }

        async function ensureAuthenticated() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log('User authenticated:', user.uid, 'Anonymous:', user.isAnonymous);
                        if (user.isAnonymous) {
                            showAnonymousWarning();
                        }
                        resolve(user);
                    } else {
                        console.log('No user, signing in anonymously...');
                        auth.signInAnonymously()
                            .then(resolve)
                            .catch(reject);
                    }
                });
            });
        }

        function showAnonymousWarning() {
            // Check if banner already exists
            if (document.querySelector('.anonymous-warning')) return;

            const banner = document.createElement('div');
            banner.className = 'anonymous-warning';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, rgba(217, 119, 6, 0.95), rgba(234, 88, 12, 0.95));
                color: white;
                padding: 12px 20px;
                text-align: center;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            banner.innerHTML = `
                ‚ö†Ô∏è Du bruker anonym modus. Data kan slettes ved cache-nullstilling.
                <button onclick="showLoginModal()" style="
                    background: white;
                    color: var(--primary);
                    border: none;
                    padding: 6px 16px;
                    border-radius: 6px;
                    font-weight: 600;
                    cursor: pointer;
                    margin-left: 12px;
                    font-size: 13px;
                ">Logg inn</button>
            `;
            document.body.prepend(banner);

            // Adjust body padding to account for banner
            document.body.style.paddingTop = '60px';
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);

            document.getElementById('lang-no').classList.toggle('active', lang === 'no');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');

            updateUI();
            renderList();
        }

        function t(key) {
            const keys = key.split('.');
            let value = TRANSLATIONS[currentLanguage];
            for (const k of keys) {
                value = value[k];
            }
            return value || key;
        }

        function updateUI() {
            document.getElementById('app-title').textContent = t('appTitle');
            document.getElementById('searchInput').placeholder = t('searchPlaceholder');
            document.getElementById('adhd-text').innerHTML = t('adhdExplanation');

            const buttons = document.querySelectorAll('.button-group button');
            if (buttons[0]) buttons[0].textContent = t('shareListBtn');
            if (buttons[1]) buttons[1].textContent = t('importListBtn');
            if (buttons[2]) buttons[2].textContent = t('clearListBtn');

            const addAllBtn = document.getElementById('addAllBtn');
            if (addAllBtn) addAllBtn.textContent = t('addAllBtn');

            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) cancelBtn.textContent = t('cancelBtn');

            document.getElementById('shareModalTitle').textContent = t('shareModalTitle');
            document.getElementById('shareCodeLabel').textContent = t('shareCodeLabel');
            document.getElementById('importModalTitle').textContent = t('importModalTitle');
            document.getElementById('importCodeLabel').textContent = t('importCodeLabel');
            document.getElementById('importCode').placeholder = t('importCodePlaceholder');

            // Update footer
            const footerCredit = document.getElementById('footer-credit');
            if (footerCredit) {
                footerCredit.innerHTML = t('footerCredit') + ' - <a href="mailto:hei@hallvar.no" style="color: var(--primary); text-decoration: none;">hei@hallvar.no</a>';
            }

            const privacyNotice = document.getElementById('privacy-notice');
            if (privacyNotice) {
                privacyNotice.textContent = t('privacyNotice');
            }
        }

        function setupSearchListeners() {
            const searchInput = document.getElementById('searchInput');
            const autocomplete = document.getElementById('autocomplete');

            // Auto-resize textarea
            searchInput.addEventListener('input', (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';

                const text = e.target.value;
                const isBulkInput = detectBulkInput(text);

                if (isBulkInput) {
                    autocomplete.style.display = 'none';
                    handleBulkInput(text);
                } else {
                    document.getElementById('previewSection').style.display = 'none';
                    const query = text.trim();
                    if (query.length > 0) {
                        showAutocomplete(query);
                    } else {
                        autocomplete.style.display = 'none';
                    }
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                const autocomplete = document.getElementById('autocomplete');
                const isAutocompleteVisible = autocomplete.style.display === 'block';

                if (e.key === 'ArrowDown' && isAutocompleteVisible) {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, currentAutocompleteMatches.length - 1);
                    updateAutocompleteSelection();
                } else if (e.key === 'ArrowUp' && isAutocompleteVisible) {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                    updateAutocompleteSelection();
                } else if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const text = e.target.value.trim();

                    if (detectBulkInput(text)) {
                        return;
                    }

                    if (isAutocompleteVisible && selectedAutocompleteIndex >= 0) {
                        const selected = currentAutocompleteMatches[selectedAutocompleteIndex];
                        selectAutocomplete(selected.item, selected.category);
                    } else if (text) {
                        addItem(text);
                        e.target.value = '';
                        e.target.style.height = 'auto';
                        autocomplete.style.display = 'none';
                    }
                    selectedAutocompleteIndex = -1;
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !autocomplete.contains(e.target)) {
                    autocomplete.style.display = 'none';
                }
            });
        }

        function detectBulkInput(text) {
            const lines = text.split('\n').filter(l => l.trim().length > 0);
            const hasMultipleLines = lines.length > 1;
            const hasMultipleCommas = (text.match(/,/g) || []).length >= 2;
            return hasMultipleLines || hasMultipleCommas;
        }

        let currentParsedItems = [];

        function handleBulkInput(text) {
            const items = parseText(text);
            currentParsedItems = [];
            const recognized = [];
            const unrecognized = [];

            items.forEach(item => {
                const normalized = normalizeText(item);

                if (learnedVariants[normalized]) {
                    recognized.push({ text: item, category: learnedVariants[normalized].category });
                    currentParsedItems.push({ text: item, category: learnedVariants[normalized].category });
                } else {
                    const match = findBestMatch(normalized);
                    if (match) {
                        recognized.push({ text: item, category: match.category });
                        currentParsedItems.push({ text: item, category: match.category });
                        learnedVariants[normalized] = { original: match.item, category: match.category };
                    } else {
                        unrecognized.push(item);
                        currentParsedItems.push({ text: item, category: null });
                    }
                }
            });

            displayInlinePreview(recognized, unrecognized);
        }

        function displayInlinePreview(recognized, unrecognized) {
            const previewSection = document.getElementById('previewSection');
            const recognizedItems = document.getElementById('inlineRecognizedItems');
            const recognizedCount = document.getElementById('inlineRecognizedCount');
            const unrecognizedContainer = document.getElementById('inlineUnrecognizedContainer');
            const unrecognizedItems = document.getElementById('inlineUnrecognizedItems');

            document.querySelector('#previewSection .preview-header').innerHTML = `${t('recognizedItems')} (<span id="inlineRecognizedCount">${recognized.length}</span>):`;

            recognizedItems.innerHTML = recognized.map(item => `
                <div class="preview-item">
                    <span class="preview-item-text">${item.text}</span>
                    <span class="preview-item-category">‚Üí ${t('categories.' + item.category)}</span>
                </div>
            `).join('') || `<p style="color: #86868b;">${currentLanguage === 'no' ? 'Ingen gjenkjente varer' : 'No recognized items'}</p>`;

            if (unrecognized.length > 0) {
                unrecognizedContainer.style.display = 'block';
                document.querySelector('#inlineUnrecognizedContainer .preview-header').textContent = t('unknownItems') + ':';
                unrecognizedItems.innerHTML = unrecognized.map((item, index) => `
                    <div class="unrecognized-item">
                        <input type="text" value="${item}" readonly>
                        <select id="inline-category-${index}">
                            <option value="">${t('selectCategory')}</option>
                            ${CATEGORIES.map(cat => `<option value="${cat}">${t('categories.' + cat)}</option>`).join('')}
                        </select>
                    </div>
                `).join('');
            } else {
                unrecognizedContainer.style.display = 'none';
            }

            previewSection.style.display = 'block';
        }

        function addParsedItems() {
            const unrecognizedSelects = document.querySelectorAll('[id^="inline-category-"]');
            let allCategoriesSelected = true;

            unrecognizedSelects.forEach((select, index) => {
                const category = select.value;
                if (!category) {
                    allCategoriesSelected = false;
                } else {
                    const itemIndex = currentParsedItems.findIndex(item => item.category === null);
                    if (itemIndex !== -1) {
                        currentParsedItems[itemIndex].category = category;
                        const itemText = currentParsedItems[itemIndex].text;
                        customItems[itemText] = category;
                        learnedVariants[normalizeText(itemText)] = { original: itemText, category };
                    }
                }
            });

            if (!allCategoriesSelected) {
                alert(t('alertSelectCategory'));
                return;
            }

            currentParsedItems.forEach(item => {
                if (item.category) {
                    addItemToList(item.text, item.category);
                }
            });

            saveToStorage();
            cancelBulkInput();
        }

        function cancelBulkInput() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').style.height = 'auto';
            document.getElementById('previewSection').style.display = 'none';
            currentParsedItems = [];
        }

        function showAutocomplete(query) {
            const autocomplete = document.getElementById('autocomplete');
            const matches = findMatches(query);
            currentAutocompleteMatches = matches.slice(0, 8);
            selectedAutocompleteIndex = -1;

            if (currentAutocompleteMatches.length === 0) {
                autocomplete.style.display = 'none';
                return;
            }

            autocomplete.innerHTML = currentAutocompleteMatches.map((match, index) => `
                <div class="autocomplete-item" onclick="selectAutocomplete('${match.item}', '${match.category}')" data-index="${index}">
                    <span>${match.item}</span>
                    <span class="autocomplete-category">${match.category}</span>
                </div>
            `).join('');

            autocomplete.style.display = 'block';
        }

        function updateAutocompleteSelection() {
            const items = document.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                if (index === selectedAutocompleteIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function findMatches(query) {
            const normalizedQuery = normalizeText(query).toLowerCase();
            const matches = [];
            const db = currentLanguage === 'en' ? DATABASE_EN : DATABASE;

            for (const [category, items] of Object.entries(db)) {
                for (const item of items) {
                    if (normalizeText(item).toLowerCase().includes(normalizedQuery)) {
                        matches.push({ item, category });
                    }
                }
            }

            for (const [item, category] of Object.entries(customItems)) {
                if (normalizeText(item).toLowerCase().includes(normalizedQuery)) {
                    matches.push({ item, category });
                }
            }

            for (const [variant, data] of Object.entries(learnedVariants)) {
                if (normalizeText(variant).toLowerCase().includes(normalizedQuery)) {
                    matches.push({ item: variant, category: data.category });
                }
            }

            return matches;
        }

        function selectAutocomplete(item, category) {
            addItemToList(item, category);
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').style.height = 'auto';
            document.getElementById('autocomplete').style.display = 'none';
            selectedAutocompleteIndex = -1;
            currentAutocompleteMatches = [];
        }

        function normalizeText(text) {
            return text
                .toLowerCase()
                .replace(/[^a-z√¶√∏√•0-9\s]/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function addItem(userInput) {
            const normalized = normalizeText(userInput);

            if (learnedVariants[normalized]) {
                addItemToList(userInput, learnedVariants[normalized].category);
                return;
            }

            const match = findBestMatch(normalized);

            if (match) {
                addItemToList(userInput, match.category);
                learnedVariants[normalized] = { original: match.item, category: match.category };
                saveToStorage();
            } else {
                askUserForCategory(userInput);
            }
        }

        function findBestMatch(normalized) {
            const words = normalized.split(' ').filter(w => !FILLER_WORDS.includes(w));
            const cleanedWords = words.filter(w => !ADJECTIVES.includes(w) && !/^\d+$/.test(w) && !/^\d+[a-z]+$/.test(w));
            const searchTerms = cleanedWords.length > 0 ? cleanedWords : words;
            const db = currentLanguage === 'en' ? DATABASE_EN : DATABASE;

            for (const term of searchTerms) {
                for (const [category, items] of Object.entries(db)) {
                    for (const item of items) {
                        const normalizedItem = normalizeText(item);
                        if (normalizedItem === term || normalizedItem.includes(term) || term.includes(normalizedItem)) {
                            return { item, category };
                        }
                    }
                }

                for (const [item, category] of Object.entries(customItems)) {
                    const normalizedItem = normalizeText(item);
                    if (normalizedItem === term || normalizedItem.includes(term) || term.includes(normalizedItem)) {
                        return { item, category };
                    }
                }
            }

            for (const term of searchTerms) {
                const singular = term.endsWith('er') ? term.slice(0, -2) : term;
                const plural = term + 'er';

                for (const [category, items] of Object.entries(db)) {
                    for (const item of items) {
                        const normalizedItem = normalizeText(item);
                        if (normalizedItem === singular || normalizedItem === plural ||
                            normalizedItem.includes(singular) || normalizedItem.includes(plural)) {
                            return { item, category };
                        }
                    }
                }
            }

            return null;
        }

        function askUserForCategory(item) {
            const category = prompt(`Hvilken kategori h√∏rer "${item}" til?\n\nTilgjengelige kategorier:\n${CATEGORIES.map((c, i) => `${i + 1}. ${c}`).join('\n')}\n\nSkriv inn nummer (1-${CATEGORIES.length}):`);

            if (category !== null) {
                const categoryIndex = parseInt(category) - 1;
                if (categoryIndex >= 0 && categoryIndex < CATEGORIES.length) {
                    const selectedCategory = CATEGORIES[categoryIndex];
                    customItems[item] = selectedCategory;
                    addItemToList(item, selectedCategory);
                    saveToStorage();
                }
            }
        }

        function addItemToList(name, category) {
            const existingItem = shoppingList.find(item =>
                normalizeText(item.name) === normalizeText(name) && item.category === category
            );

            if (!existingItem) {
                let displayName = name;

                const strongBeerTypes = ['ipa', 'stout', 'porter', 'brown ale', 'pale ale', 'wheat beer', 'witbier', 'sterk√∏l'];
                const normalizedName = normalizeText(name);

                if (category === 'Vinmonopolet' && strongBeerTypes.some(type => normalizedName.includes(type))) {
                    if (!name.includes('(mulig polet)') && !normalizedName.includes('sterk√∏l')) {
                        displayName = `${name} (mulig polet)`;
                    }
                }

                const newItemId = Date.now() + Math.random();
                shoppingList.push({
                    id: newItemId,
                    name: displayName,
                    category,
                    checked: false,
                    note: ''
                });

                // Set last added item for highlighting
                lastAddedItemId = newItemId;
                lastAddedCategory = category;

                saveToStorage();
                renderList();

                // Clear highlight after animation
                setTimeout(() => {
                    lastAddedItemId = null;
                }, 3000);
            }
        }

        function toggleItem(id) {
            const item = shoppingList.find(item => item.id === id);
            if (item) {
                item.checked = !item.checked;
                saveToStorage();
                renderList();
            }
        }

        function deleteItem(id) {
            shoppingList = shoppingList.filter(item => item.id !== id);
            saveToStorage();
            renderList();
        }

        function clearList() {
            if (shoppingList.length === 0) {
                alert(t('alertListEmpty'));
                return;
            }

            if (confirm(t('alertConfirmClear'))) {
                shoppingList = [];
                saveToStorage();
                renderList();
            }
        }

        function renderList() {
            const container = document.getElementById('shoppingList');

            if (shoppingList.length === 0) {
                container.innerHTML = '';
                return;
            }

            const grouped = {};
            CATEGORIES.forEach(cat => {
                grouped[cat] = shoppingList.filter(item => item.category === cat);
            });

            // Sort categories to show the last added category first
            const sortedCategories = [...CATEGORIES].sort((a, b) => {
                if (a === lastAddedCategory) return -1;
                if (b === lastAddedCategory) return 1;
                return 0;
            });

            container.innerHTML = sortedCategories.map(category => {
                const items = grouped[category];
                if (items.length === 0) return '';

                const itemsHtml = items.map(item => {
                    const isHighlighted = item.id === lastAddedItemId;
                    const noteHtml = item.note ? `<div class="item-note">${item.note}</div>` : '';
                    return `
                        <div class="item ${item.checked ? 'checked' : ''} ${isHighlighted ? 'highlight' : ''}" onclick="toggleItem(${item.id})">
                            <input type="checkbox" ${item.checked ? 'checked' : ''}>
                            <div style="flex: 1;">
                                <div class="item-name">${item.name}</div>
                                ${noteHtml}
                            </div>
                            <button class="edit-note-btn" onclick="event.stopPropagation(); editNote(${item.id})" title="Rediger notat">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteItem(${item.id})">√ó</button>
                        </div>
                    `;
                }).join('');

                const itemWord = currentLanguage === 'no' ?
                    (items.length !== 1 ? 'varer' : 'vare') :
                    (items.length !== 1 ? 'items' : 'item');

                return `
                    <div class="category">
                        <div class="category-header">
                            <span>${t('categories.' + category)}</span>
                            <span class="category-count">${items.length} ${itemWord}</span>
                        </div>
                        <div class="items-list">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }


        function parseText(text) {
            let items = [];

            text = text.replace(/\d+\.\s*/g, '\n');
            text = text.replace(/[-‚Ä¢]\s*/g, '\n');

            const lines = text.split('\n');

            lines.forEach(line => {
                if (line.includes(',')) {
                    items.push(...line.split(','));
                } else {
                    items.push(line);
                }
            });

            items = items.map(item => {
                item = item.replace(/\b\d+\s*(kg|g|l|ml|stk|pk|boks|pose|brett|pakke)?\b/gi, '');
                item = item.replace(/[^\w√¶√∏√•√Ü√ò√Ö\s]/g, ' ');
                return item.trim();
            }).filter(item => {
                const words = item.toLowerCase().split(' ');
                return item.length > 0 && !words.every(w => FILLER_WORDS.includes(w));
            });

            return items;
        }


        function saveToStorage() {
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            localStorage.setItem('customItems', JSON.stringify(customItems));
            localStorage.setItem('learnedVariants', JSON.stringify(learnedVariants));
        }

        function loadFromStorage() {
            const savedList = localStorage.getItem('shoppingList');
            const savedCustom = localStorage.getItem('customItems');
            const savedVariants = localStorage.getItem('learnedVariants');

            if (savedList) shoppingList = JSON.parse(savedList);
            if (savedCustom) customItems = JSON.parse(savedCustom);
            if (savedVariants) learnedVariants = JSON.parse(savedVariants);
        }

        function shareList() {
            if (shoppingList.length === 0) {
                alert(t('alertListEmpty'));
                return;
            }

            // Bare del navn og kategori (ikke id, checked, note) for kortere kode
            const minimalItems = shoppingList.map(item => [item.name, item.category]);

            const jsonString = JSON.stringify(minimalItems);
            // Bruk LZ-String komprimering for √• redusere kodelengden betydelig
            const compressed = LZString.compressToEncodedURIComponent(jsonString);

            document.getElementById('shareCode').value = compressed;

            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';

            const shareUrl = window.location.origin + window.location.pathname + '?import=' + compressed;

            // Generer QR-kode lokalt med QRCode.js
            try {
                new QRCode(qrcodeDiv, {
                    text: shareUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });
            } catch (e) {
                qrcodeDiv.innerHTML = '<p style="color: #86868b; padding: 20px;">QR-kode kunne ikke genereres</p>';
            }

            document.getElementById('shareModal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function copyShareCode() {
            const codeInput = document.getElementById('shareCode');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            document.execCommand('copy');

            alert(t('codeCopied'));
        }

        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importCode').value = '';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function importList() {
            const code = document.getElementById('importCode').value.trim();

            if (!code) return;

            try {
                let jsonString;

                // Pr√∏v f√∏rst med LZ-String dekomprimering (ny format)
                try {
                    jsonString = LZString.decompressFromEncodedURIComponent(code);
                    if (!jsonString) throw new Error('Dekomprimering feilet');
                } catch (e) {
                    // Hvis det feiler, pr√∏v gammel base64-format (bakoverkompatibilitet)
                    jsonString = decodeURIComponent(atob(code));
                }

                const listData = JSON.parse(jsonString);

                // H√•ndter nytt format (array av [name, category])
                if (Array.isArray(listData) && listData.length > 0 && Array.isArray(listData[0])) {
                    shoppingList = listData.map(([name, category]) => ({
                        id: Date.now() + Math.random(),
                        name,
                        category,
                        checked: false,
                        note: ''
                    }));

                    saveToStorage();
                    renderList();
                    closeImportModal();
                    alert(t('importSuccess'));
                }
                // H√•ndter gammelt format (objekt med items, customItems, learnedVariants)
                else if (listData.items && Array.isArray(listData.items)) {
                    shoppingList = listData.items;
                    customItems = listData.customItems || {};
                    learnedVariants = listData.learnedVariants || {};

                    saveToStorage();
                    renderList();
                    closeImportModal();
                    alert(t('importSuccess'));
                } else {
                    throw new Error('Invalid format');
                }
            } catch (e) {
                alert(t('importError'));
            }
        }

        function checkUrlImport() {
            const urlParams = new URLSearchParams(window.location.search);
            const importCode = urlParams.get('import');

            if (importCode) {
                try {
                    let jsonString;

                    // Pr√∏v f√∏rst med LZ-String dekomprimering (ny format)
                    try {
                        jsonString = LZString.decompressFromEncodedURIComponent(importCode);
                        if (!jsonString) throw new Error('Dekomprimering feilet');
                    } catch (e) {
                        // Hvis det feiler, pr√∏v gammel base64-format (bakoverkompatibilitet)
                        jsonString = decodeURIComponent(atob(importCode));
                    }

                    const listData = JSON.parse(jsonString);

                    if (listData.items && Array.isArray(listData.items)) {
                        if (confirm(currentLanguage === 'no' ?
                            'Vil du importere denne handlelisten?' :
                            'Do you want to import this shopping list?')) {
                            shoppingList = listData.items;
                            customItems = listData.customItems || {};
                            learnedVariants = listData.learnedVariants || {};

                            saveToStorage();
                            renderList();
                        }
                    }
                } catch (e) {
                    console.error('Import failed:', e);
                }

                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function editNote(id) {
            const item = shoppingList.find(item => item.id === id);
            if (!item) return;

            currentEditingItemId = id;
            document.getElementById('noteItemName').textContent = item.name;
            document.getElementById('noteInput').value = item.note || '';
            document.getElementById('noteModal').classList.add('active');

            setTimeout(() => {
                document.getElementById('noteInput').focus();
            }, 100);
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            currentEditingItemId = null;
        }

        function saveNote() {
            if (!currentEditingItemId) return;

            const item = shoppingList.find(item => item.id === currentEditingItemId);
            if (!item) return;

            item.note = document.getElementById('noteInput').value.trim();

            saveToStorage();
            renderList();
            closeNoteModal();
        }

        // ========== FIREBASE HELPER FUNCTIONS ==========

        let globalItemsCache = null;
        let globalCategoriesCache = null;

        async function loadGlobalItemsCache() {
            // Check if cache is fresh (< 24h old)
            const cacheTime = localStorage.getItem('globalItemsCacheTime');
            const now = Date.now();

            if (cacheTime && (now - parseInt(cacheTime) < 24 * 60 * 60 * 1000)) {
                globalItemsCache = JSON.parse(localStorage.getItem('globalItemsCache') || '{}');
                globalCategoriesCache = JSON.parse(localStorage.getItem('globalCategoriesCache') || '[]');
                console.log('Loaded global items from cache');
                return;
            }

            console.log('Fetching fresh global items from Firestore...');

            try {
                // Fetch global items
                const itemsSnapshot = await db.collection('globalItems')
                    .where('approved', '==', true)
                    .get();

                globalItemsCache = {};
                itemsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const lang = currentLanguage === 'en' ? 'name_en' : 'name_no';
                    if (!globalItemsCache[data.category]) {
                        globalItemsCache[data.category] = [];
                    }
                    if (data[lang]) {
                        globalItemsCache[data.category].push(data[lang]);
                    }
                });

                // Fetch global categories
                const categoriesSnapshot = await db.collection('globalCategories')
                    .where('approved', '==', true)
                    .orderBy('order')
                    .get();

                globalCategoriesCache = categoriesSnapshot.docs.map(doc => doc.data());

                // Cache to localStorage
                localStorage.setItem('globalItemsCache', JSON.stringify(globalItemsCache));
                localStorage.setItem('globalCategoriesCache', JSON.stringify(globalCategoriesCache));
                localStorage.setItem('globalItemsCacheTime', now.toString());

                console.log('Global items cached successfully');
            } catch (error) {
                console.error('Error loading global items:', error);
                // Fallback to hardcoded DATABASE if Firestore fails
                globalItemsCache = DATABASE;
                globalCategoriesCache = CATEGORIES.map((cat, index) => ({
                    name_no: cat,
                    order: index
                }));
            }

            // If Firestore is empty, use hardcoded DATABASE as fallback
            if (!globalItemsCache || Object.keys(globalItemsCache).length === 0) {
                console.warn('Firestore is empty, using hardcoded DATABASE');
                globalItemsCache = DATABASE;
                globalCategoriesCache = CATEGORIES.map((cat, index) => ({
                    name_no: cat,
                    order: index
                }));
            }
        }

        function setupRealtimeListeners(userId) {
            // Listen to default shopping list
            db.collection('users').doc(userId).collection('lists').doc('default')
                .onSnapshot(snapshot => {
                    if (snapshot.exists) {
                        console.log('List updated from Firestore');
                        shoppingList = snapshot.data().items || [];
                        renderList();
                    }
                }, error => {
                    console.error('Error listening to list:', error);
                });

            // Listen to custom items
            db.collection('users').doc(userId).collection('customItems')
                .onSnapshot(snapshot => {
                    customItems = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const lang = currentLanguage === 'en' ? 'name_en' : 'name_no';
                        if (data[lang]) {
                            customItems[data[lang]] = data.category;
                        }
                    });
                    console.log('Custom items updated:', Object.keys(customItems).length);
                }, error => {
                    console.error('Error listening to custom items:', error);
                });
        }

        async function migrateLocalStorageToFirestore(userId) {
            console.log('Starting localStorage to Firestore migration...');

            const batch = db.batch();

            // Migrate shoppingList to default list
            const savedList = localStorage.getItem('shoppingList');
            const shoppingListData = savedList ? JSON.parse(savedList) : [];

            if (shoppingListData.length > 0) {
                const listRef = db.collection('users').doc(userId).collection('lists').doc('default');
                batch.set(listRef, {
                    name: 'Min Liste',
                    items: shoppingListData,
                    sharedWith: [],
                    shareCode: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Migrating ${shoppingListData.length} items to Firestore`);
            }

            // Migrate customItems
            const savedCustom = localStorage.getItem('customItems');
            const customItemsData = savedCustom ? JSON.parse(savedCustom) : {};

            Object.entries(customItemsData).forEach(([itemName, category]) => {
                const itemRef = db.collection('users').doc(userId).collection('customItems').doc();
                batch.set(itemRef, {
                    name_no: itemName,
                    name_en: null, // Will trigger Cloud Function for translation
                    category,
                    pendingApproval: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            if (Object.keys(customItemsData).length > 0) {
                console.log(`Migrating ${Object.keys(customItemsData).length} custom items`);
            }

            // Migrate language preference
            const language = localStorage.getItem('language') || 'no';
            const userRef = db.collection('users').doc(userId);
            batch.set(userRef, {
                isAnonymous: auth.currentUser.isAnonymous,
                email: auth.currentUser.email || null,
                preferences: { language },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            try {
                await batch.commit();
                localStorage.setItem('migratedToFirestore', 'true');
                localStorage.setItem('migrationDate', new Date().toISOString());
                console.log('Migration completed successfully');
            } catch (error) {
                console.error('Migration failed:', error);
                alert('Kunne ikke migrere data til skyen. Pr√∏ver igjen ved neste lasting.');
            }
        }

        function showLoginModal() {
            alert('P√•loggingsfunksjonalitet kommer snart! For n√• bruker du anonym modus.');
            // TODO: Implement login modal in next step
        }

        // ========== SEED FUNCTIONS (Run once to populate Firestore) ==========

        async function seedGlobalItems() {
            console.log('Starting to seed Firestore with global items and categories...');

            const batch = db.batch();
            let itemCount = 0;
            let categoryCount = 0;

            // Seed globalCategories
            CATEGORIES.forEach((cat, index) => {
                const catRef = db.collection('globalCategories').doc();
                const emoji = TRANSLATIONS.no.categories[cat] ? TRANSLATIONS.no.categories[cat].split(' ')[0] : 'üì¶';
                const name_en = TRANSLATIONS.en.categories[cat] ? TRANSLATIONS.en.categories[cat].replace(emoji + ' ', '') : cat;

                batch.set(catRef, {
                    name_no: cat,
                    name_en: name_en,
                    emoji: emoji,
                    order: index,
                    approved: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                categoryCount++;
            });

            // Seed globalItems from DATABASE (Norwegian)
            Object.entries(DATABASE).forEach(([category, items]) => {
                items.forEach(itemName => {
                    // Find English translation from DATABASE_EN
                    let enName = itemName; // Default to Norwegian if not found

                    if (DATABASE_EN[category]) {
                        const indexInNo = DATABASE[category].indexOf(itemName);
                        if (indexInNo !== -1 && DATABASE_EN[category][indexInNo]) {
                            enName = DATABASE_EN[category][indexInNo];
                        }
                    }

                    const itemRef = db.collection('globalItems').doc();
                    batch.set(itemRef, {
                        name_no: itemName,
                        name_en: enName,
                        category: category,
                        approved: true,
                        usageCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    itemCount++;
                });
            });

            try {
                await batch.commit();
                console.log(`‚úÖ Seeding complete! Added ${categoryCount} categories and ${itemCount} items to Firestore.`);
                alert(`Database populert! ${categoryCount} kategorier og ${itemCount} varer lagt til. Last siden p√• nytt.`);
            } catch (error) {
                console.error('‚ùå Seeding failed:', error);
                alert('Kunne ikke populere database: ' + error.message);
            }
        }

        // Make seedGlobalItems available globally for console access
        window.seedGlobalItems = seedGlobalItems;

        // ========== END FIREBASE HELPER FUNCTIONS ==========

        initializeApp();
        checkUrlImport();
    </script>
</body>
</html>
